# # These tests are not run; there appear to be some minor bugs that should be addressed
# # ===============================================================================================
#
# # TESTING ANCOVA WITH LM OBJECT WITH INTERCEPTS UNEQUAL TO ZERO AND TWO COVARIATES
#
# rm(list=ls())
rm(list=ls())
df <- sesamesim
df$site <- as.factor(df$site)
model <- lm(postnumb~site+prenumb+peabody-1, df)
model <- label_estimates(model, c("v.1", "v.2", "v.3", "v.4", "v.5", "pre", "pea"))
set.seed(100)
y <- bain(model, "v.1 = 19.35 & v.2 = 29.33;v.1>19.35&v.2>29.33")
test_that("Bain mutual", {expect_equal(y$fit$Com[1], 0.0007, tolerance = .0005)})


  # TESTING ANCOVA WITH BAIN DEFAULT WITH INTERCEPTS UNEQUAL TO ZERO AND TWO COVARIATES
  sesamesim$prenumb <- sesamesim$prenumb-mean(sesamesim$prenumb)
  sesamesim$peabody <- sesamesim$peabody-mean(sesamesim$peabody)

  ancov <- lm(postnumb ~ site + prenumb + peabody -1, data = sesamesim)
  est <- coef(ancov)
  samp <- table(sesamesim$site)
  prep.var <- (summary(ancov)$sigma)**2

  cat1 <- subset(cbind(sesamesim$site,sesamesim$prenumb,sesamesim$peabody), sesamesim$site == 1)
  cat1[,1] <- 1
  cat1 <- as.matrix(cat1)
  cov1 <- prep.var * solve(t(cat1) %*% cat1)

  cat2 <- subset(cbind(sesamesim$site,sesamesim$prenumb,sesamesim$peabody), sesamesim$site == 2)
  cat2[,1] <- 1
  cat2 <- as.matrix(cat2)
  cov2 <- prep.var * solve(t(cat2) %*% cat2)

  cat3 <- subset(cbind(sesamesim$site,sesamesim$prenumb,sesamesim$peabody), sesamesim$site == 3)
  cat3[,1] <- 1
  cat3 <- as.matrix(cat3)
  cov3 <- prep.var * solve(t(cat3) %*% cat3)

  cat4 <- subset(cbind(sesamesim$site,sesamesim$prenumb,sesamesim$peabody), sesamesim$site == 4)
  cat4[,1] <- 1
  cat4 <- as.matrix(cat4)
  cov4 <- prep.var * solve(t(cat4) %*% cat4)

  cat5 <- subset(cbind(sesamesim$site,sesamesim$prenumb,sesamesim$peabody), sesamesim$site == 5)
  cat5[,1] <- 1
  cat5 <- as.matrix(cat5)
  cov5 <- prep.var * solve(t(cat5) %*% cat5)

  covariances <- list(cov1, cov2, cov3, cov4,cov5)
  names(est)<- c("v.1", "v.2", "v.3", "v.4","v.5", "pre", "pea")
  hyp<-"v.1=19.35 & v.2 = 29.33; v.1>19.35 & v.2 > 29.33;"

  set.seed(100)
  z<-bain(est,hyp,n=samp,Sigma=covariances,group_parameters=1,joint_parameters = 2)

  # TESTING BAIN LM AND DEFAULT VERSUS EACH OTHER

  test_that("Bain mutual", {expect_equal(y$fit$Fit , z$fit$Fit, tolerance = .001)})
  test_that("Bain mutual", {expect_equal(y$fit$Com , z$fit$Com, tolerance = .001)})
  test_that("Bain mutual", {expect_equal(y$independent_restrictions, z$independent_restrictions)})
  test_that("Bain mutual", {expect_equal(y$b, z$b)})
  test_that("Bain mutual", {expect_equal(as.vector(y$posterior), as.vector(z$posterior))})
  test_that("Bain mutual", {expect_equal(as.vector(y$prior), as.vector(z$prior))})
  test_that("Bain mutual", {expect_equal(y$fit$BF,z$fit$BF)})
  test_that("Bain mutual", {expect_equal(y$fit$PMPb , z$fit$PMPb)})
  test_that("Bain mutual", {expect_equal(as.vector(t(y$BFmatrix)), as.vector(t(z$BFmatrix)))})

  # ===============================================================================================


  # TESTING ANCOVA WITH LM OBJECT WITH INTERCEPTS UNEQUAL TO ZERO AND ONE COVARIATE

  rm(list=ls())

  sesamesim$site <- as.factor(sesamesim$site)
  ancov <- lm(postnumb ~ site + prenumb -1, data = sesamesim)
  ancov <- label_estimates(ancov, c("v.1", "v.2", "v.3","v.4", "v.5", "pre"))
  #hyp<-"v.1=19.35 & v.2 = 29.33; v.1>19.35 & v.2 > 29.33;"
  set.seed(100)

  y <- bain(ancov, "v.1=19.35 & v.2 = 29.33; v.1>19.35 & v.2 > 29.33")

  sesamesim$prenumb <- sesamesim$prenumb-mean(sesamesim$prenumb)

  ancov <- lm(postnumb ~ site + prenumb  -1, data = sesamesim)
  est <- coef(ancov)
  samp <- table(sesamesim$site)
  prep.var <- (summary(ancov)$sigma)**2

  cat1 <- subset(cbind(sesamesim$site,sesamesim$prenumb), sesamesim$site == 1)
  cat1[,1] <- 1
  cat1 <- as.matrix(cat1)
  cov1 <- prep.var * solve(t(cat1) %*% cat1)

  cat2 <- subset(cbind(sesamesim$site,sesamesim$prenumb), sesamesim$site == 2)
  cat2[,1] <- 1
  cat2 <- as.matrix(cat2)
  cov2 <- prep.var * solve(t(cat2) %*% cat2)

  cat3 <- subset(cbind(sesamesim$site,sesamesim$prenumb), sesamesim$site == 3)
  cat3[,1] <- 1
  cat3 <- as.matrix(cat3)
  cov3 <- prep.var * solve(t(cat3) %*% cat3)

  cat4 <- subset(cbind(sesamesim$site,sesamesim$prenumb), sesamesim$site == 4)
  cat4[,1] <- 1
  cat4 <- as.matrix(cat4)
  cov4 <- prep.var * solve(t(cat4) %*% cat4)

  cat5 <- subset(cbind(sesamesim$site,sesamesim$prenumb), sesamesim$site == 5)
  cat5[,1] <- 1
  cat5 <- as.matrix(cat5)
  cov5 <- prep.var * solve(t(cat5) %*% cat5)

  covariances <- list(cov1, cov2, cov3, cov4,cov5)
  names(est)<- c("v.1", "v.2", "v.3", "v.4","v.5", "pre")
  hyp<-"v.1=19.35 & v.2 = 29.33; v.1>19.35 & v.2 > 29.33;"

  set.seed(100)
  z<-bain(est,hyp,n=samp,Sigma=covariances,group_parameters=1,joint_parameters = 1)

  # TESTING BAIN LM AND DEFAULT VERSUS EACH OTHER

  test_that("Bain mutual", {expect_equal(y$fit$Fit , z$fit$Fit)})
  test_that("Bain mutual", {expect_equal(y$fit$Com , z$fit$Com)})
  test_that("Bain mutual", {expect_equal(y$independent_restrictions, z$independent_restrictions)})
  test_that("Bain mutual", {expect_equal(y$b, z$b)})
  test_that("Bain mutual", {expect_equal(as.vector(y$posterior), as.vector(z$posterior))})
  test_that("Bain mutual", {expect_equal(as.vector(y$prior), as.vector(z$prior))})
  test_that("Bain mutual", {expect_equal(y$fit$BF,z$fit$BF)})
  test_that("Bain mutual", {expect_equal(y$fit$PMPb , z$fit$PMPb)})
  test_that("Bain mutual", {expect_equal(as.vector(t(y$BFmatrix)), as.vector(t(z$BFmatrix)))})
